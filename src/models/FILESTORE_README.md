# FileStore

The FileStore class manages a collection of markdown files, each representing a node in a tree structure. It is designed to be resilient to missing or malformed data.

## Usage Assumptions

- **Local Development**: The server is intended to run locally, on demand
- **No Concurrent Access**: Files should not be edited while the server is running
- **Manual Editing**: Files can be manually edited between server runs, and the FileStore will heal any missing data on next startup

## File Format

Each node is stored as a markdown file with YAML frontmatter:

```md
---
id: 123e4567-e89b-12d3-a456-426614174000
title: Node Title
childrenIds: []
parentId: null
setMetrics:
  readinessLevel: 5
calculatedMetrics:
  readinessLevel: 0
---

This is the node's description in markdown format.
```

## File Healing

The FileStore automatically heals files with missing data. This means you can create a completely empty markdown file, and FileStore will populate it with the necessary metadata.

### Healing Rules

When reading a file, if any required data is missing:

1. **Missing ID**: Generates a new UUID
2. **Missing Title**: Uses the filename (without .md extension)
3. **Missing ChildrenIds**: Defaults to empty array `[]`
4. **Missing ParentId**: Defaults to `null`
5. **Missing CalculatedMetrics**: Defaults to `{ readinessLevel: 0 }`
6. **Missing Description**: Defaults to empty string
7. **Missing SetMetrics**: Omitted entirely (optional field)

The healing process is automatic and happens on the first read of a file. The healed data is immediately written back to the file.

### Example

If you create a file named `my-node.md` with no content:

```md

```

It will be automatically healed to:

```md
---
id: <auto-generated-uuid>
title: my-node
childrenIds: []
parentId: null
calculatedMetrics:
  readinessLevel: 0
---
```

## Readiness Level Handling

Readiness levels can be set in two ways:

1. Through `setMetrics.readinessLevel` in the YAML
2. Directly through the `readinessLevel` property in API calls

Both methods are supported and will be properly handled. When no readiness level is set:

1. Leaf nodes (no children) default to readiness level 0
2. Parent nodes calculate their readiness level as the minimum of their children's levels

## File Operations

- **Create**: Creates a new markdown file with complete metadata
- **Update**: Preserves existing metadata, updates only changed fields
- **Delete**: Removes the file and updates parent references
- **Move**: Updates both old and new parent references

## Error Handling

While the FileStore is resilient to missing data, it does not attempt to handle:

- Malformed YAML (let the YAML parser handle this)
- Invalid file permissions
- Filesystem errors
- Circular parent-child relationships (explicitly prevented)
